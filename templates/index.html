<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claudia García - Abogada</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .phone-container {
            width: 280px;
            height: 600px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .scales-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .profile-section {
            text-align: center;
            position: relative;
        }
        
        .avatar-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            background: #e2e8f0 url('https://bidamericas.com/tusabogados/foto.png') center/cover;
            position: relative;
            z-index: 2;
        }
        
        .pulse-rings {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            z-index: 1;
            opacity: 0;
        }
        
        .pulse-rings.active {
            opacity: 1;
        }
        
        .pulse-ring {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            animation: pulse 2s ease-out infinite;
        }
        
        .pulse-ring:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .pulse-ring:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.75);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }
        
        .profile-name {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }
        
        .profile-title {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            margin-bottom: 40px;
        }
        
        .action-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: all 0.3s ease;
            font-size: 24px;
            position: relative;
            z-index: 3;
        }
        
        .whatsapp-button {
            background: #25d366;
            color: white;
        }
        
        .whatsapp-button:hover {
            background: #128c7e;
            transform: scale(1.05);
        }
        
        .end-call-button {
            background: #ef4444;
            color: white;
        }
        
        .end-call-button:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .button-label {
            color: white;
            font-size: 14px;
            font-weight: 500;
            margin-top: 15px;
            text-align: center;
        }
        
        .status-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            display: none;
            z-index: 10;
        }
        
        .loading-dots {
            display: inline-block;
            margin-left: 5px;
        }
        
        .loading-dots span {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            margin: 0 1px;
            animation: bounce 1.5s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        /* Estados de la interfaz */
        .interface-state {
            transition: all 0.3s ease;
        }
        
        .interface-state.calling .pulse-rings {
            opacity: 1;
        }
        
        .interface-state.calling .whatsapp-button {
            display: none;
        }
        
        .interface-state.calling .end-call-button {
            display: flex;
        }
        
        .interface-state:not(.calling) .end-call-button {
            display: none;
        }
        
        @media (max-width: 320px) {
            .phone-container {
                width: 260px;
                height: 560px;
            }
            
            .avatar-container {
                width: 100px;
                height: 100px;
            }
            
            .profile-name {
                font-size: 20px;
            }
            
            .profile-title {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="error-message" id="errorMessage"></div>
        
        <div class="header">
            <div class="logo-container">
                <svg class="scales-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2M8 11.5L6.5 16.5L11.5 17.2L13 12.2L8 11.5M16 11.5L13 12.2L14.5 17.2L19.5 16.5L18 11.5L16 11.5Z"/>
                </svg>
                <div class="logo-text">tusabogados.com</div>
            </div>
            
            <div class="profile-section interface-state" id="interfaceState">
                <div class="avatar-container">
                    <div class="avatar"></div>
                    <div class="pulse-rings" id="pulseRings">
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring"></div>
                    </div>
                </div>
                
                <div class="profile-name">Claudia García</div>
                <div class="profile-title">Abogada</div>
                
                <button class="action-button whatsapp-button" id="whatsappButton" onclick="startCall()">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.520-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.570-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.525 3.585"/>
                    </svg>
                </button>
                
                <button class="action-button end-call-button" id="endCallButton" onclick="endCall()">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                        <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.1-.7-.28-.79-.73-1.68-1.36-2.66-1.85-.33-.16-.56-.51-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
                    </svg>
                </button>
                
                <div class="button-label" id="buttonLabel">Marcar</div>
            </div>
        </div>
        
        <div class="status-indicator" id="statusIndicator">Listo para hablar</div>
    </div>

    <script>
        let voiceSupported = false;
        let recognition = null;
        let isListening = false;
        let isProcessing = false;
        let isSpeaking = false;
        let currentTTSMode = 'browser';
        let isCalling = false;
        
        // URLs base de la API - usar rutas relativas para Render
        const API_BASE_URL = '';
        const CHAT_API_URL = '/api/chat';
        const SPEAK_API_URL = '/api/speak';
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkVoiceSupport();
            
            // Verificar si estamos en un entorno de producción (Render)
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            
            if (isProduction) {
                // En producción, verificar estado del servidor
                checkServerStatus();
            } else {
                // En desarrollo, mantener el comportamiento actual
                showTTSEmergencyMode();
                
                // Mensaje de bienvenida por voz
                setTimeout(() => {
                    speakText("Hola, soy Claudia García, tu abogada virtual. ¿En qué puedo ayudarte hoy?");
                }, 1000);
            }
        }

        function checkServerStatus() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        // Mensaje de bienvenida por voz
                        setTimeout(() => {
                            speakText("Hola, soy Claudia García, tu abogada virtual. ¿En qué puedo ayudarte hoy?");
                        }, 1000);
                    } else {
                        showTTSEmergencyMode();
                        
                        // Mensaje de bienvenida por voz en modo offline
                        setTimeout(() => {
                            speakText("Hola, estoy en modo offline. ¿En qué puedo ayudarte hoy?");
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking server status:', error);
                    showTTSEmergencyMode();
                    
                    // Mensaje de bienvenida por voz en modo offline
                    setTimeout(() => {
                        speakText("Hola, estoy en modo offline. ¿En qué puedo ayudarte hoy?");
                    }, 1000);
                });
        }

        function showTTSEmergencyMode() {
            currentTTSMode = 'browser';
        }

        function checkVoiceSupport() {
            voiceSupported = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            
            if (!voiceSupported) {
                document.getElementById('statusIndicator').textContent = "Voz no compatible";
                showError("Tu navegador no soporta reconocimiento de voz. Por favor usa Chrome o Edge.");
            }
        }

        function startCall() {
            if (!voiceSupported) {
                showError("El reconocimiento de voz no es compatible con tu navegador. Usa Chrome o Edge.");
                return;
            }

            if (isProcessing) {
                showError("Estoy procesando tu solicitud. Por favor espera.");
                return;
            }

            isCalling = true;
            const interfaceState = document.getElementById('interfaceState');
            const buttonLabel = document.getElementById('buttonLabel');
            const statusIndicator = document.getElementById('statusIndicator');
            
            interfaceState.classList.add('calling');
            buttonLabel.textContent = 'Finalizar';
            statusIndicator.textContent = 'Escuchando...';
            
            startVoiceRecognition();
        }

        function endCall() {
            isCalling = false;
            const interfaceState = document.getElementById('interfaceState');
            const buttonLabel = document.getElementById('buttonLabel');
            const statusIndicator = document.getElementById('statusIndicator');
            
            interfaceState.classList.remove('calling');
            buttonLabel.textContent = 'Marcar';
            statusIndicator.textContent = 'Listo para hablar';
            
            stopVoiceRecognition();
        }

        function startVoiceRecognition() {
            const statusIndicator = document.getElementById('statusIndicator');
            
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                isListening = true;
                statusIndicator.textContent = "Escuchando...";
                hideError();
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log("Usuario dijo:", transcript);
                
                isListening = false;
                recognition.stop();
                
                statusIndicator.innerHTML = "Procesando<span class='loading-dots'><span></span><span></span><span></span></span>";
                
                // Usar función offline en lugar de fetch
                sendChatMessage(transcript);
            };
            
            recognition.onerror = function(event) {
                console.error('Error en reconocimiento:', event.error);
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    showError("Error de reconocimiento: " + event.error);
                }
                if (isCalling) {
                    setTimeout(() => {
                        if (isCalling && !isProcessing && !isSpeaking) {
                            try {
                                recognition.start();
                            } catch (error) {
                                console.error('Error reiniciando reconocimiento:', error);
                            }
                        }
                    }, 1000);
                }
            };
            
            recognition.onend = function() {
                console.log("Reconocimiento finalizado");
                if (isListening && !isProcessing && !isSpeaking && isCalling) {
                    console.log("Reiniciando reconocimiento...");
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Error reiniciando reconocimiento:', error);
                    }
                }
            };
            
            try {
                recognition.start();
                console.log("Reconocimiento iniciado");
            } catch (error) {
                console.error('Error al activar el micrófono:', error);
                showError('Error al activar el micrófono: ' + error.message);
            }
        }

        function sendChatMessage(message) {
            isProcessing = true;
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.innerHTML = "Procesando<span class='loading-dots'><span></span><span></span><span></span></span>";
            
            // En producción, intentar conectar al servidor primero
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            
            if (isProduction) {
                fetch(CHAT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    isProcessing = false;
                    speakText(data.response);
                })
                .catch(error => {
                    console.error('Error al conectar con el servidor:', error);
                    // Si falla, usar modo offline
                    useOfflineMode(message);
                });
            } else {
                // En desarrollo, usar modo offline directamente
                useOfflineMode(message);
            }
        }

        function useOfflineMode(message) {
            // Simular respuesta del servidor offline con respuestas legales
            setTimeout(() => {
                let response = "";
                const messageLower = message.toLowerCase();
                
                if (messageLower.includes('hola') || messageLower.includes('buenos') || messageLower.includes('saludos')) {
                    response = "Hola, soy Claudia García, abogada especializada en derecho civil y familiar. ¿En qué asunto legal puedo asesorarte hoy?";
                }
                else if (messageLower.includes('divorcio') || messageLower.includes('separación')) {
                    response = "Entiendo que necesitas asesoría sobre divorcio. Podemos revisar tu caso, evaluar los bienes conyugales, custodia de hijos y pensión alimentaria. ¿Cuál es tu situación específica?";
                }
                else if (messageLower.includes('custodia') || messageLower.includes('hijos') || messageLower.includes('menor')) {
                    response = "En temas de custodia, siempre priorizamos el bienestar del menor. Podemos trabajar en custodia compartida, patria potestad y régimen de visitas. Te ayudo a proteger los derechos de tus hijos.";
                }
                else if (messageLower.includes('pensión') || messageLower.includes('alimentaria') || messageLower.includes('cuota')) {
                    response = "Para pensión alimentaria, calcularemos el monto según los ingresos del obligado y las necesidades del beneficiario. Puedo ayudarte tanto a solicitarla como a modificarla o defenderla.";
                }
                else if (messageLower.includes('herencia') || messageLower.includes('sucesión') || messageLower.includes('testamento')) {
                    response = "En procesos sucesorales, te asesoro sobre inventario de bienes, liquidación de herencia, testamentos y resolución de conflictos entre herederos. ¿Hay algún aspecto específico que te preocupa?";
                }
                else if (messageLower.includes('contrato') || messageLower.includes('demanda') || messageLower.includes('civil')) {
                    response = "En derecho civil, manejo contratos, responsabilidad civil, demandas por incumplimiento y daños. Puedo revisar tu situación y determinar la mejor estrategia legal.";
                }
                else if (messageLower.includes('laboral') || messageLower.includes('trabajo') || messageLower.includes('despido')) {
                    response = "Para temas laborales, te asesoro sobre despidos injustificados, liquidaciones, acoso laboral y derechos del trabajador. ¿Qué situación específica estás enfrentando?";
                }
                else if (messageLower.includes('precio') || messageLower.includes('costo') || messageLower.includes('honorarios')) {
                    response = "Mis honorarios varían según la complejidad del caso. Ofrezco primera consulta gratuita donde evaluamos tu situación. Para casos complejos, manejamos cuotas accesibles.";
                }
                else if (messageLower.includes('consulta') || messageLower.includes('cita') || messageLower.includes('reunión')) {
                    response = "Perfecto, podemos agendar tu consulta. Ofrezco atención presencial y virtual. La primera consulta es gratuita para evaluar tu caso. ¿Qué días y horarios te convienen?";
                }
                else if (messageLower.includes('gracias')) {
                    response = "Ha sido un placer asesorarte. Recuerda que estoy aquí para proteger tus derechos legales. No dudes en contactarme cuando necesites apoyo jurídico.";
                }
                else {
                    const responses = [
                        "Como tu abogada, necesito más detalles de tu situación para brindarte el mejor asesoramiento legal. ¿Podrías contarme más sobre tu caso?",
                        "Entiendo tu consulta. En mi práctica legal, cada caso es único. Te sugiero agendar una consulta para revisar todos los aspectos legales involucrados.",
                        "Para brindarte una asesoría precisa, necesitaríamos revisar la documentación y detalles específicos de tu situación legal. ¿Te gustaría agendar una cita?"
                    ];
                    response = responses[Math.floor(Math.random() * responses.length)];
                }
                
                isProcessing = false;
                speakText(response);
                
            }, 1000); // Simular delay de procesamiento
        }

        function stopVoiceRecognition() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error("Error deteniendo reconocimiento:", error);
                }
            }
            
            isListening = false;
            isProcessing = false;
        }

        function speakText(text) {
            isSpeaking = true;
            
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.textContent = "Hablando...";
            
            // En producción, intentar usar el servidor primero
            const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            
            if (isProduction) {
                fetch(SPEAK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.useBrowserTTS) {
                        // Si el servidor indica usar el navegador
                        useBrowserTTS(text);
                    } else if (data.audioContent) {
                        // Si el servidor devuelve audio
                        playAudio(data.audioContent);
                    } else {
                        // En caso de cualquier otra situación, usar navegador
                        useBrowserTTS(text);
                    }
                })
                .catch(error => {
                    console.error('Error al conectar con el servidor TTS:', error);
                    // Si falla, usar navegador
                    useBrowserTTS(text);
                });
            } else {
                // En desarrollo, usar navegador directamente
                useBrowserTTS(text);
            }
        }

        // Función para usar la síntesis de voz del navegador
        function useBrowserTTS(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                
                utterance.onstart = function() {
                    console.log("Navegador TTS iniciado");
                };
                
                utterance.onend = function() {
                    console.log("Navegador TTS terminado");
                    handleSpeechEnd();
                };
                
                utterance.onerror = function(event) {
                    console.error("Error en navegador TTS:", event.error);
                    handleSpeechEnd();
                    showError("Error al hablar: " + event.error);
                };
                
                speechSynthesis.speak(utterance);
            } else {
                console.error("Síntesis de voz no soportada en este navegador");
                handleSpeechEnd();
                showError("La síntesis de voz no es compatible con tu navegador");
            }
        }

        // Manejar el final del habla
        function handleSpeechEnd() {
            isSpeaking = false;
            const statusIndicator = document.getElementById('statusIndicator');
            
            if (isCalling) {
                statusIndicator.textContent = "Escuchando...";
                
                if (!isListening && !isProcessing) {
                    try {
                        startVoiceRecognition();
                    } catch (error) {
                        console.error('Error reiniciando reconocimiento:', error);
                        endCall();
                    }
                }
            } else {
                statusIndicator.textContent = "Listo para hablar";
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
